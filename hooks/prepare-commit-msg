#!/bin/zsh

# μΈν…”λ¦¬μ μ΄ λ° λ‹¤μ–‘ν• ν„°λ―Έλ„ ν™κ²½ λ€μ‘
export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin"

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2 # μ»¤λ°‹ μ†μ¤ (message, template, merge λ“±)

PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
TMP_MSG_FILE="$PROJECT_ROOT/.git/GEMINI_MSG_TMP"
REPORT_FILE="$PROJECT_ROOT/GEMINI_REPORT.md"

# 1. μΌλ°μ μΈ μ»¤λ°‹ μƒν™©(μ‹ κ· μ»¤λ°‹, ν…ν”λ¦Ώ μ‚¬μ© λ“±)μ—μ„λ§ λ™μ‘
if [[ -z "$COMMIT_SOURCE" || "$COMMIT_SOURCE" == "template" || "$COMMIT_SOURCE" == "message" ]]; then
    
    # 2. pre-commit λ‹¨κ³„μ—μ„ μƒμ„±λ AI μ¶”μ² λ©”μ‹μ§€κ°€ μλ”μ§€ ν™•μΈ
    if [ -f "$TMP_MSG_FILE" ] && [ -s "$TMP_MSG_FILE" ]; then
        AI_MSG=$(cat "$TMP_MSG_FILE")
        
        # 3. AI λ©”μ‹μ§€λ¥Ό μ»¤λ°‹ λ©”μ‹μ§€μ κΈ°λ³Έκ°’μΌλ΅ μ„¤μ •
        # κΈ°μ΅΄μ— μ…λ ¥λ λ‚΄μ©μ΄ μλ”λΌλ„ AIκ°€ μ μ•ν• μ»¨λ²¤μ… λ©”μ‹μ§€λ΅ μ‹μ‘ν•λ„λ΅ κµ¬μ„±
        echo "$AI_MSG" > "$COMMIT_MSG_FILE"
        
        # 4. μƒμ„Έ λ¦¬ν¬νΈκ°€ μλ‹¤λ©΄ μ£Όμ„μΌλ΅ μ¶”κ°€ν•μ—¬ λ¦¬λ·° κ²°κ³Όλ¥Ό μ°Έκ³ ν•κ² ν•¨
        if [ -f "$REPORT_FILE" ]; then
            echo "" >> "$COMMIT_MSG_FILE"
            echo "# π¤– Gemini MSA Code Review Report" >> "$COMMIT_MSG_FILE"
            echo "# --------------------------------------------" >> "$COMMIT_MSG_FILE"
            # λ¦¬ν¬νΈμ λ¨λ“  λΌμΈ μ•μ— #μ„ λ¶™μ—¬ μ£Όμ„ μ²λ¦¬ (μ»¤λ°‹μ—λ” ν¬ν•¨λμ§€ μ•μ)
            sed 's/^/# /' "$REPORT_FILE" >> "$COMMIT_MSG_FILE"
        fi
        
        # 5. μ‚¬μ©ν• μ„μ‹ νμΌ μ •λ¦¬
        rm "$TMP_MSG_FILE"
    fi
fi
