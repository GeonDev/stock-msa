#!/bin/zsh

# ============================================================================
# AI ìžë™ ì½”ë“œ ë¦¬ë·° ì‹œìŠ¤í…œ - Pre-commit Hook (V3: í™˜ê° ë°©ì§€ ë° ì»¨ë²¤ì…˜ ê°•í™”)
# ============================================================================

set -e

export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin"
source ~/.zshrc 2>/dev/null || true

PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# 1. í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
if [ -f "$PROJECT_ROOT/.env" ]; then
    while IFS= read -r line || [ -n "$line" ]; do
        [[ $line =~ ^#.* ]] && continue
        [[ $line =~ ^[[:space:]]*$ ]] && continue
        export "$line"
    done < "$PROJECT_ROOT/.env"
fi

REPORT_FILE="$PROJECT_ROOT/GEMINI_REPORT.md"
TMP_MSG_FILE="$PROJECT_ROOT/.git/GEMINI_MSG_TMP"

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

echo "${CYAN}============================================${NC}"
echo "${CYAN}ðŸ¤– MSA ì•„í‚¤í…íŠ¸ ì œë¯¸ë‚˜ì´ ì½”ë“œ ë¦¬ë·° ì‹œìž‘${NC}"
echo "${CYAN}============================================${NC}"

rm -f "$REPORT_FILE" "$TMP_MSG_FILE"
touch "$REPORT_FILE"

# 2. ë¶„ì„ ëŒ€ìƒ íŒŒì¼ í•„í„°ë§
VALID_EXTENSIONS="java|sql|xml|html|ftl|properties|yml|yaml"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\.($VALID_EXTENSIONS)$" || true)

if [[ -z "$STAGED_FILES" ]]; then
    echo "${GREEN}[PASS] ë¶„ì„ ëŒ€ìƒ íŒŒì¼ ì—†ìŒ - ì»¤ë°‹ ì§„í–‰${NC}"
    exit 0
fi

# 3. ë¶„ì„ ë°ì´í„° êµ¬ì„± (êµ¬ë¶„ìž ê°•í™”)
CLEAN_INPUT="[SYSTEM] ë‹¹ì‹ ì€ ì½”ë“œ ë¦¬ë·°ì–´ìž…ë‹ˆë‹¤. ì•„ëž˜ ì œê³µëœ íŒŒì¼ ë‚´ìš©ë§Œ ë¶„ì„í•˜ì„¸ìš”.\n\n"
MAPPING_INFO=""
FILE_COUNTER=1

while IFS= read -r file; do
    if [[ ! -f "$PROJECT_ROOT/$file" ]]; then continue; fi
    CODE=$(git show ":$file")
    if [[ -n "$CODE" ]]; then
        FILE_ID="F${FILE_COUNTER}"
        CLEAN_INPUT+="=== START OF FILE: ${file} (ID: ${FILE_ID}) ===\n"
        CLEAN_INPUT+="${CODE}\n"
        CLEAN_INPUT+="=== END OF FILE: ${file} ===\n\n"
        MAPPING_INFO+="- **${FILE_ID}**: \`${file}\`\n"
        ((FILE_COUNTER++))
    fi
done <<< "$STAGED_FILES"

# 4. AI í”„ë¡¬í”„íŠ¸ (í™˜ê° ë°©ì§€ ë° ì»¨ë²¤ì…˜ ì§€ì¹¨)
AI_PROMPT="${CLEAN_INPUT}

[ìµœìš°ì„  ì¤€ìˆ˜ ì‚¬í•­]
1. ë‹¹ì‹ ì€ ì œê³µëœ 'í…ìŠ¤íŠ¸'ë§Œ ì½ëŠ” ìˆ˜ë™ì  ë¦¬ë·°ì–´ìž…ë‹ˆë‹¤. ì ˆëŒ€ í”„ë¡œì íŠ¸ ë‚´ì˜ ë‹¤ë¥¸ íŒŒì¼(ì˜ˆ: doc/ í´ë”)ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì°¸ì¡°í•˜ì§€ ë§ˆì„¸ìš”.
2. ì–´ë…¸í…Œì´ì…˜(@Value, @Data ë“±) ë¶„ì„ ì‹œ, íŒŒì¼ ê²½ë¡œê°€ ì–´ë…¸í…Œì´ì…˜ì— í¬í•¨ë˜ì–´ ìžˆë‹¤ëŠ” ì‹ì˜ ê±°ì§“ë§ì„ í•˜ì§€ ë§ˆì„¸ìš”. 
3. 'apiKey' í•„ë“œì— '@Value(\"\${dart.api-key}\")'ê°€ ì í˜€ ìžˆë‹¤ë©´ ì´ëŠ” ì™„ë²½í•œ ë¬¸ë²•ìž…ë‹ˆë‹¤. ì˜¤íƒ€ë‚˜ ë³´ì•ˆ ë¬¸ì œë¥¼ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”.
4. ì •ë§ë¡œ ì»´íŒŒì¼ì´ ì•ˆ ë  ìˆ˜ì¤€ì˜ ì¹˜ëª…ì ì¸ ë¬¸ì œ(ê´„í˜¸ ë¯¸ì¢…ë£Œ, ì˜¤íƒ€)ê°€ ìžˆì„ ë•Œë§Œ ###BLOCK###ì„ ì‚¬ìš©í•˜ì„¸ìš”.

[ì‘ë‹µ ì–‘ì‹]
###BLOCK### (ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ìžˆì„ ë•Œë§Œ í•œ ì¤„ ìš”ì•½, ì—†ìœ¼ë©´ ë¹„ìš¸ ê²ƒ)
###PASS### (ë¦¬ë·° ì´í‰)
###IMPACT### (í”„ë¡œì íŠ¸ ì˜í–¥ë„ ìš”ì•½)
###MSG### (ì•„ëž˜ ì»¨ë²¤ì…˜ì— ë”°ë¥¸ ì»¤ë°‹ ë©”ì‹œì§€)

[ì»¤ë°‹ ë©”ì‹œì§€ ì»¨ë²¤ì…˜]
- í˜•ì‹: <type>(<scope>): <subject>
- type: feat(ê¸°ëŠ¥), fix(ë²„ê·¸), refactor(ê°œì„ ), docs(ë¬¸ì„œ), chore(ì„¤ì •)
- scope: ë³€ê²½ëœ ëª¨ë“ˆëª… (common, corp, finance, price, strategy, gateway, discovery)
- subject: ë°˜ë“œì‹œ **í•œê¸€**ë¡œ ëª…í™•í•˜ê²Œ ìš”ì•½ (50ìž ì´ë‚´)
- ì˜ˆì‹œ: feat(corp): OpenDART ì—…ì¢… ìˆ˜ì§‘ ë°°ì¹˜ êµ¬í˜„"

# 5. AI í˜¸ì¶œ ë° ê²°ê³¼ ì²˜ë¦¬
AI_RESPONSE=$(gemini -m gemini-2.0-flash -p "$AI_PROMPT" 2>/dev/null || echo "ERROR")

# ë…¸ì´ì¦ˆ ì œê±°
CLEANED_RESPONSE=$(echo "$AI_RESPONSE" | grep -v "Loaded cached credentials" | grep -v "supports tool updates" | sed 's/\*\*//g')

parse_section() {
    local tag="$1"
    echo "$CLEANED_RESPONSE" | awk -v t="$tag" '
        $0 ~ t {found=1; next}
        found && /^###.*###/ {found=0}
        found {print}
    ' | sed 's/```//g' | sed '/^[[:space:]]*$/d'
}

BLOCK_REASON=$(parse_section "###BLOCK###")

if [[ -n "$BLOCK_REASON" ]]; then
    echo "${RED}ðŸš¨ [BLOCK] ì»¤ë°‹ ê±°ë¶€${NC}"
    echo "${RED}ì‚¬ìœ : ${BLOCK_REASON}${NC}"
    echo "### ðŸš¨ ë¦¬ë·° ì°¨ë‹¨ ì‚¬ìœ \n\n${BLOCK_REASON}\n\n### ðŸ“ ì „ì²´ ë¦¬ë·° ë‚´ìš©\n\n${CLEANED_RESPONSE}" > "$REPORT_FILE"
    exit 1
else
    echo "${GREEN}âœ… [PASS] ì½”ë“œ ë¦¬ë·° í†µê³¼!${NC}"
    COMMIT_MSG=$(parse_section "###MSG###")
    echo "$COMMIT_MSG" > "$TMP_MSG_FILE"
    echo "# ðŸ¤– Gemini MSA ë¦¬ë·° ë¦¬í¬íŠ¸\n\n${CLEANED_RESPONSE}" > "$REPORT_FILE"
    exit 0
fi
