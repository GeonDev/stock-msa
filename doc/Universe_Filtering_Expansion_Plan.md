# Universe Filtering 확장 실행 계획

## 1. 개요
현재 `UniverseFilterService`는 지정된 시장(KOSPI/KOSDAQ)의 모든 종목을 반환하는 단순한 기능을 수행하고 있습니다. 실제 퀀트 전략에서는 유동성이 낮거나, 시가총액이 너무 작거나, 특정 업종(예: 금융, 지주사)을 제외하는 등의 정교한 필터링이 필수적입니다. 본 계획서는 이를 위한 단계적 확장 방안을 다룹니다.

## 2. 주요 확장 영역

### 2.1. 기본 정량 필터 (Quantitative Filters)
`UniverseFilterCriteria`에 정의된 필드들을 실제 로직에 반영합니다.
- **시가총액 필터**: `minMarketCap`, `maxMarketCap`을 이용해 대형주/중소형주 유니버스 구성.
- **거래량 필터**: `minTradingVolume`을 이용해 유동성이 확보된 종목만 선정 (슬리피지 방지).
- **업종 필터**: `excludeSectors`를 이용해 분석이 까다롭거나 전략에 부적합한 업종(금융, 관리종목 등) 제외.

### 2.2. 순위 및 비율 필터 (Rank & Percentile Filters)
단순 수치 비교가 아닌 유니버스 내에서의 상대적 위치를 기반으로 필터링합니다.
- **시가총액 상위 N% / 하위 N%**: 소형주 효과 전략 등을 위해 필요.
- **거래량 상위 N개**: 시장의 관심을 받는 종목군 선정.

### 2.3. 상세 지표 필터 (Structured Custom Filters)
`CustomFilterCriteria` DTO를 통해 타입 안정성이 보장된 상세 지표 필터링을 수행합니다.
- **재무 건전성 및 가치 지표**:
    - **가치(Value)**: PER, PBR, PSR 범위를 지정하여 저평가 종목 발굴.
    - **수익성(Profitability)**: ROE 최소값 설정 및 `onlyProfitable` 필터를 통한 흑자 기업(당기순이익 > 0) 선별.
    - **안정성(Stability)**: 부채비율(`maxDebtRatio`) 제한을 통한 재무 위험 종목 제외.
- **기술적 모멘텀 지표**:
    - **추세(Momentum)**: 1개월, 3개월, 6개월 수익률(`minMomentum`) 조건을 결합하여 상승 추세에 올라탄 종목 유니버스 구성.

## 3. 단계별 구현 계획

### Phase 1: 기본 및 상세 필터 활성화 (Short-term)
- **기본 연동**: `stock-price` 및 `stock-corp` 서비스와 연동하여 시가총액, 거래량, 업종 데이터를 가져옵니다.
- **상세 지표 연동**: `stock-finance` 서비스와 연동하여 PER, PBR, ROE 등 재무 지표를 필터링 조건에 결합합니다.
- **모멘텀 반영**: 주가 데이터를 활용해 계산된 모멘텀 수치로 유니버스를 필터링합니다.
- **우선순위**: 시가총액/거래량/업종 -> 흑자여부/재무지표 -> 모멘텀 순으로 구현합니다.

### Phase 2: 데이터 조회 최적화 (Mid-term)
- 유니버스 필터링은 매 리밸런싱마다 발생하므로 성능이 중요합니다.
- **Batch API 활용**: 종목별로 하나씩 조회하지 않고, 시장 전체 데이터를 한 번에 가져와 메모리에서 필터링하거나 DB에서 처리합니다.
- **캐싱**: 동일한 기준일과 조건의 필터링 결과는 캐싱하여 반복 계산을 방지합니다.

### Phase 3: 동적 필터링 엔진 (Long-term)
- **QueryDSL 도입**: 다양한 조건을 조합한 동적 쿼리를 생성하여 DB 레벨에서 필터링 효율을 극대화합니다.
- **복합 로직 지원**: (조건A AND 조건B) OR (조건C) 와 같은 복잡한 논리 구조를 지원합니다.

## 4. 데이터 연동 구조 (Data Flow)

1.  **Market List**: `CorpClient`를 통해 해당 시장의 전체 종목 리스트 획득.
2.  **Market Data**: `PriceClient`를 통해 종목별 시가총액, 거래량 정보 획득.
3.  **Sector Info**: `CorpClient`를 통해 종목별 업종 정보 확인.
4.  **Financial Data**: (필요 시) `FinanceClient`를 통해 재무 지표 확인.
5.  **Filtering**: 모든 조건을 만족하는 종목 코드(`stockCode`) 리스트 최종 산출.

## 5. 기대 효과
- **전략 신뢰도 향상**: 유동성이 없는 종목에 의한 백테스트 왜곡 방지.
- **전략 다양성**: 시가총액별, 업종별 다양한 전략 실험 가능.
- **계산 효율성**: 불필요한 종목을 초기에 제거하여 전체 시뮬레이션 속도 향상.
