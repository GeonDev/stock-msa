# Phase 1: Data Integrity & Preprocessing Plan

## 개요
퀀트 투자 시스템의 신뢰성을 확보하기 위해 원천 데이터(시세, 재무)의 무결성을 검증하고, 백테스팅에 필수적인 수정주가 및 기술적 지표를 선행 계산하여 저장하는 것을 목표로 합니다.

## 주요 마일스톤 및 진행 현황

### 1. 데이터 기반 인프라 구축 [DONE]
- [x] 주가/거래량 데이터 오버플로우 방지를 위한 `Long` 타입 리팩토링.
- [x] 전역 예외 처리 및 공통 DTO 구조 확립.
- [x] 공공데이터 API 연동 규격 통일 (XML 기반 파싱 및 URL 인코딩 이슈 해결).

### 2. 기업 이벤트 수집 및 수정주가 계산 [IN PROGRESS]
- [x] **기업 이벤트 히스토리 수집**: 액면분할, 증자, 감자 등 주가에 영향을 주는 이벤트 수집 로직 구현 (`CorpEventService`).
- [x] **수정주가 산출 엔진**: 과거 시세 데이터에 수정계수(Adjustment Factor)를 적용하여 수정종가(`adj_close_price`) 계산 로직 구현 (`AdjustedPriceService`).
- [x] **배치 파이프라인 통합**: 시세 수집 -> 이벤트 수집 -> 수정주가 계산 순서의 Batch Step 구성 완료.

### 3. 기술적 지표 사전 계산 [DONE]
- [x] **Ta4j 라이브러리 통합**: `ta4j-core:0.22.1` 기반의 지표 계산 엔진 구축.
- [x] **주요 지표 구현**:
    - 이동평균선: MA5, 20, 60, 120, 200, 250.
    - 변동성 및 추세: RSI(14), MACD(12, 26, 9), Bollinger Bands(20, 2).
- [x] **라이브러리 최적화**: `ta4j` 버전 업그레이드에 따른 패키지 경로(averages) 수정 및 타임존(`Asia/Seoul`) 설정 적용.

### 4. 데이터 정합성 검증 (Next Step) [IN PROGRESS]
- [x] **재무 데이터 검증 로직 구현**:
    - **필수 필드 검사 (Null Check)**:
        - 핵심 지표: 매출액, 영업이익, 당기순이익, 자산총계, 부채총계, 자본총계.
        - 위 항목 중 하나라도 누락(`0` 또는 `NULL`) 시 `INVALID` 상태로 마킹.
    - **대차대조표 등식 검증**:
        - `자산총계 = 부채총계 + 자본총계` 공식 성립 여부 확인.
        - 데이터 제공처의 반올림 오차를 고려하여 `0.1%` 이내의 오차는 허용 (`Tolerance Check`).
    - **이상치 탐지 (Outlier Detection)**:
        - 전년 동기 대비 변동폭이 비정상적으로 큰 경우 (예: `> 1000%` 증가/감소) `REQUIRES_REVIEW` 상태 부여.
        - 시가총액 상위 종목임에도 PER/PBR 등 투자지표가 `0`인 경우 플래그 처리.
- [x] **검증 상태 관리 프로세스**:
    - `ValidationStatus` Enum (`UNCHECKED`, `VALID`, `INVALID`, `REQUIRES_REVIEW`)을 활용하여 각 재무 레코드의 신뢰도 관리.
    - 배치 수행 시 `INVALID` 상태인 데이터는 퀀트 전략 계산 대상에서 자동으로 제외.
- [ ] **데이터 갭 분석**: 휴장일을 제외한 평일 데이터 중 누락된 시세 데이터 추출 및 재수집 로직.

## 기술적 특이사항
- **수정주가 계산**: 현재 액면분할 및 무상증자 패턴에 대해 우선 적용되었으며, 유상증자 및 합병 시나리오는 Phase 2에서 고도화 예정.
- **성능 최적화**: 배치 작업 시 `JpaPagingItemReader`를 사용하여 대용량 시세 데이터 처리 시 메모리 점유율을 최소화함.
- **정밀도 관리**: 주가 계산 시 `BigDecimal`을 사용하여 부동 소수점 오차 방지.
- **재무 검증**: `FinanceValidationService`를 통해 수집 직후 즉시 검증을 수행하며, 배치 파이프라인(`CorpFinanceJob`)에 통합됨.

---
*마지막 업데이트: 2026-02-05 (Phase 1 구현 완료)*
