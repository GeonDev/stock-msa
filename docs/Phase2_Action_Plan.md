# Phase 2 실행 계획 (Action Plan): 백테스팅 엔진 고도화

## 1. 개요
본 문서는 `docs/Implementation_Roadmap.md`에 정의된 Phase 2 (백테스팅 엔진)의 미완료 작업들에 대한 구체적인 실행 계획을 정의합니다. 진행 중인 백테스팅 엔진의 기능적 완성도를 높이고, 보다 현실적이고 정교한 시뮬레이션 환경을 구축하는 것을 목표로 합니다.

## 2. 대상 작업 목표
- **2.2 전략 관리 및 최적화**: 전략 간 성과 비교 및 최적 파라미터 탐색 기능
- **2.3 거래 비용 반영**: 슬리피지 모델링 및 현실적인 거래 제약 조건 적용

---

## 3. 세부 구현 계획

### 3.1 전략 관리 및 최적화

#### 3.1.1 전략 비교 기능 (Strategy Comparison)
- **목표**: 여러 백테스트 실행 결과를 한눈에 비교할 수 있는 데이터 구조 및 API 구현
- **구현 항목**:
  - `CompareStrategiesResponse` DTO 설계 (여러 `BacktestResult`를 테이블/차트용 데이터로 변환)
  - 주요 지표(CAGR, MDD, Sharpe, Volatility, Win Rate) 기반 랭킹 알고리즘 구현
  - 누적 수익률(Cumulative Return) 시계열 데이터 병합 및 동기화 로직 (차트 표시용)
- **API Spec**:
  - `GET /api/v1/strategy/backtest/compare?resultIds={id1},{id2},...`

#### 3.1.2 전략 최적화 (Parameter Grid Search)
- **목표**: 주어진 파라미터 범위 내에서 최적의 성과를 내는 전략 파라미터 자동 탐색
- **구현 항목**:
  - `GridSearchRequest` DTO 설계 (최적화 대상 파라미터 목록, 범위, 스텝 지정)
  - 병렬 처리(Parallel Stream 또는 Async)를 활용한 다중 백테스트 실행 엔진 구현
  - 지정된 최적화 목표(Target Metric, 예: Max CAGR 또는 Max Sharpe)에 따른 결과 정렬 기능
- **API Spec**:
  - `POST /api/v1/strategy/optimize`

### 3.2 거래 비용 반영 (현실화)

#### 3.2.1 슬리피지 (Slippage) 모델링 적용
- **목표**: 시장가 주문 시 발생하는 슬리피지를 시뮬레이션에 반영하여 수익률의 과대계산 방지
- **구현 항목**:
  - `SlippageModel` 인터페이스 및 구현체 작성 (예: `FixedSlippageModel`, `VolumeBasedSlippageModel`)
  - 고정 슬리피지: 매매 시 가격에 고정 비율(예: 0.2%) 적용
  - 거래량 기반 슬리피지: 주문량이 일일 평균 거래량의 일정 비율을 초과할 때 페널티 부과
  - 백테스팅 엔진(`BacktestEngine`)의 체결 가격 계산 로직에 슬리피지 적용

#### 3.2.2 거래 제약 구현 (Trading Constraints)
- **목표**: 실제 주식 시장의 거래 규칙을 시뮬레이션에 강제
- **구현 항목**:
  - **최소 거래 단위**: 소수점 주식 매매 방지, 1주 단위로 매수 수량 `floor` 처리
  - **단일 종목 최대 비중 제한**: 포트폴리오 다각화를 위해 한 종목에 할당 가능한 최대 자산 비율(예: 20%) 제한 로직 추가
  - **유동성 제약**: 일일 거래량의 특정 비율(예: 5%) 이상 매수/매도 불가 조건 추가
  - `OrderManager` 또는 `PortfolioManager` 내에 제약 검증(Validation) 로직 통합

---

## 4. DB 및 도메인 모델 변경 사항
- **BacktestResult 엔티티 확장**: 사용된 슬리피지 설정, 최적화 여부 등 메타데이터 저장 컬럼 추가 필요
- **BacktestRequest DTO 확장**: 거래 제약 설정(최대 비중, 유동성 제한 기준 등) 및 슬리피지 파라미터 입력 필드 추가

## 5. 검증 및 테스트 계획 (Testing & Verification)
1. **단위 테스트 (Unit Test)**:
   - 슬리피지 적용 전후의 체결 가격 정확성 검증 (오차율 0% 목표, `BigDecimal` 연산)
   - 잔고 부족 및 단일 종목 최대 비중 초과 시 매수 거절 로직 동작 확인
2. **통합 테스트 (Integration Test)**:
   - 그리드 서치 API 호출 시 다중 파라미터 조합에 대해 정확한 개수의 백테스트가 실행되는지 검증
3. **정합성 검증**:
   - 기존 완료된 거래 비용(수수료, 세금)과 슬리피지가 중복 또는 누락 없이 최종 수익금에 반영되는지 교차 검증

## 6. 진행 일정 (예상)
- **1주차**: 슬리피지 모델링 및 거래 제약 구현 (3.2 완료)
- **2주차**: 전략 비교 API 및 그리드 서치 기반 전략 최적화 로직 구현 (3.1 완료)
- **3주차**: 통합 테스트, 엣지 케이스 검증 및 문서화
