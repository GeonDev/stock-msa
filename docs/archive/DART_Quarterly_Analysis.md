# DART API 분기별 데이터 수집 분석

## 현재 상태 분석

### 1. 현재 구조의 한계
**문제점**:
- `TB_CORP_FINANCE`의 Primary Key: `(corp_code, bas_dt)`
- 연간 데이터만 수집 (사업보고서, `reprt_code=11011`)
- 분기별 데이터 구분 불가
- QoQ (Quarter over Quarter), YoY (Year over Year) 성장률 계산 불가

**현재 수집 데이터**:
```
2024-12-31: 2024년 연간 실적 (사업보고서)
2023-12-31: 2023년 연간 실적 (사업보고서)
```

### 2. DART API 보고서 코드
| 코드 | 보고서 종류 | 기준일 | 누적 데이터 |
|------|------------|--------|------------|
| 11013 | 1분기보고서 | 3월 31일 | 1분기 누적 |
| 11012 | 반기보고서 | 6월 30일 | 1~2분기 누적 |
| 11014 | 3분기보고서 | 9월 30일 | 1~3분기 누적 |
| 11011 | 사업보고서 | 12월 31일 | 연간 누적 |

**중요**: DART API는 **누적 데이터**를 반환합니다.
- 1분기: 1~3월 실적
- 반기: 1~6월 실적 (1분기 포함)
- 3분기: 1~9월 실적 (1~2분기 포함)
- 연간: 1~12월 실적 (전체 포함)

---

## 개선 방안

### Option 1: 보고서 코드 컬럼 추가 (권장)

#### 장점
- 기존 구조 최소 변경
- 분기별 데이터 명확히 구분
- QoQ, YoY 성장률 계산 가능

#### 구현 방안
```sql
-- Primary Key 변경
ALTER TABLE TB_CORP_FINANCE
    DROP PRIMARY KEY,
    ADD COLUMN report_code VARCHAR(5) NOT NULL COMMENT '보고서코드 (11013:1Q, 11012:2Q, 11014:3Q, 11011:연간)',
    ADD PRIMARY KEY (corp_code, biz_year, report_code);

-- 기존 bas_dt는 보조 인덱스로 유지
CREATE INDEX idx_bas_dt ON TB_CORP_FINANCE(bas_dt);
```

#### 데이터 구조
```
corp_code | biz_year | report_code | bas_dt     | revenue | op_income
----------|----------|-------------|------------|---------|----------
00123456  | 2024     | 11013       | 2024-03-31 | 1000억  | 100억 (1Q)
00123456  | 2024     | 11012       | 2024-06-30 | 2200억  | 230억 (1H 누적)
00123456  | 2024     | 11014       | 2024-09-30 | 3500억  | 380억 (9M 누적)
00123456  | 2024     | 11011       | 2024-12-31 | 5000억  | 550억 (연간)
```

#### 분기 실적 계산 로직
```java
// 2분기 단독 실적 = 반기 누적 - 1분기
Q2_revenue = 반기_revenue - 1분기_revenue
Q2_revenue = 2200억 - 1000억 = 1200억

// 3분기 단독 실적 = 3분기 누적 - 반기 누적
Q3_revenue = 3분기_revenue - 반기_revenue
Q3_revenue = 3500억 - 2200억 = 1300억

// 4분기 단독 실적 = 연간 - 3분기 누적
Q4_revenue = 연간_revenue - 3분기_revenue
Q4_revenue = 5000억 - 3500억 = 1500억
```

---

### Option 2: 분기별 테이블 분리

#### 장점
- 연간/분기 데이터 완전 분리
- 쿼리 성능 최적화

#### 단점
- 테이블 2개 관리 필요
- 조인 복잡도 증가

#### 구현 방안
```sql
-- 연간 데이터 (기존)
TB_CORP_FINANCE_ANNUAL
- corp_code, biz_year (PK)
- 연간 실적

-- 분기 데이터 (신규)
TB_CORP_FINANCE_QUARTERLY
- corp_code, biz_year, quarter (PK)
- 분기별 누적 실적
```

---

## 추가 수집 가능한 지표

### 1. QoQ (Quarter over Quarter) 성장률
```
QoQ 매출 성장률 = (Q2 매출 - Q1 매출) / Q1 매출 × 100
QoQ 영업이익 성장률 = (Q2 영업이익 - Q1 영업이익) / Q1 영업이익 × 100
```

### 2. YoY (Year over Year) 성장률
```
YoY 매출 성장률 = (2024 Q1 매출 - 2023 Q1 매출) / 2023 Q1 매출 × 100
YoY 영업이익 성장률 = (2024 Q1 영업이익 - 2023 Q1 영업이익) / 2023 Q1 영업이익 × 100
```

### 3. 분기별 수익성 지표
- 분기별 영업이익률 (Operating Margin)
- 분기별 순이익률 (Net Margin)
- 분기별 ROE, ROA

### 4. 계절성 분석
- 분기별 매출 비중
- 성수기/비수기 패턴 파악

### 5. 실적 추세 분석
- 4분기 연속 성장 여부
- 실적 개선/악화 추세

---

## 구현 우선순위

### Phase 1: 기본 분기 데이터 수집 (2-3일)
1. `report_code` 컬럼 추가 (Flyway 마이그레이션)
2. Primary Key 변경
3. `DartClient` 수정: 4개 보고서 모두 수집
4. 분기별 데이터 저장 로직

### Phase 2: 분기 실적 계산 (1-2일)
1. 분기 단독 실적 계산 서비스
2. QoQ, YoY 성장률 계산
3. `TB_CORP_FINANCE_INDICATOR`에 분기 지표 추가

### Phase 3: 분석 API 제공 (1-2일)
1. 분기별 실적 조회 API
2. 성장률 추이 API
3. 계절성 분석 API

---

## 예상 효과

### 1. 데이터 품질 향상
- 연간 데이터: 2,500개 → 분기 데이터: 10,000개 (4배)
- 더 세밀한 실적 추이 파악

### 2. 퀀트 전략 고도화
- 분기 실적 서프라이즈 전략
- 계절성 기반 매매 전략
- 실적 모멘텀 전략

### 3. 리스크 관리
- 조기 실적 악화 감지
- 분기별 리밸런싱 근거 제공

---

## 권장 사항

**Option 1 (보고서 코드 추가)** 를 권장합니다.

**이유**:
1. 기존 구조 최소 변경
2. 구현 복잡도 낮음
3. 유지보수 용이
4. 모든 분기 데이터를 하나의 테이블에서 관리

**다음 단계**:
1. Flyway 마이그레이션 작성
2. Entity 수정 (복합키 변경)
3. DartClient 수정 (4개 보고서 수집)
4. 배치 로직 수정
5. 분기 실적 계산 서비스 구현
